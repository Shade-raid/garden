<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Garden Idle - A relaxing gardening idle game where you grow plants, earn coins, and become a master gardener!">
    <title>Garden Idle</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAAAAABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAAAAAAAA6Or/AMzMzADU1tQA2NjYAP///wDc3NwA4ODgAOTk5ADo6OgA7OzsANTU1ADw8PAA9PT0APj4+AD8/PwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAAAAAAAAAAAICAgICAgIAAAAAAAAAAAACAgICAgIAAAAAAAAAAAACAgICAgIAAAAAAAAAAAACAgICAgIAAAAAAAAAAAACAgICAgIAAAAAAAAAAAACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgI=">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* --- General Setup & Theming --- */
        :root {
            /* Colors */
            --pink-100: #fff1f2; --pink-400: #fb7185; --pink-500: #ec4899;
            /* Loading Screen */
            --loading-bg: rgba(255, 255, 255, 0.9);
            --loading-text: #1f2937;
            /* Animation Timing */
            --transition-speed: 0.3s;
            --green-50: #f0fdf4; --green-100: #dcfce7; --green-300: #86efac; --green-400: #4ade80; --green-500: #22c55e; --green-600: #16a34a;
            --sky-200: #bae6fd; --blue-300: #93c5fd; --blue-500: #3b82f6; --blue-600: #2563eb;
            --yellow-100: #fef9c3; --yellow-300: #fde047; --yellow-400: #facc15; --yellow-500: #eab308; --yellow-800: #92400e; --yellow-900: #78350f;
            --red-100: #fee2e2; --red-500: #ef4444;
            --emerald-100: #d1fae5; --emerald-700: #047857;
            --orange-100: #fff7ed; --orange-500: #f97316;
            --purple-100: #f5f3ff; --purple-500: #a855f7; --purple-600: #9333ea; --purple-700: #7e22ce;
            --cyan-100: #cffafe; --cyan-500: #06b6d4; --cyan-800: #155e75;
            --indigo-100: #e0e7ff; --indigo-600: #4f46e5;
            --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-300: #d1d4db; --gray-400: #9ca3af; --gray-500: #6b7280; --gray-800: #1f2937;
            --white: #ffffff;
            --black: #000000;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #f0f0f0;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        button {
            cursor: pointer;
            border: none;
            background: none;
            font-family: inherit;
            font-size: inherit;
            padding: 0;
            color: inherit;
        }

        button:disabled {
            cursor: not-allowed;
        }

        .hidden { display: none !important; }

        /* --- Screens --- */
        .screen {
            min-height: 100vh;
            width: 100%;
        }

        /* --- Menu Screen --- */
        #screen-menu {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-image: linear-gradient(to bottom right, var(--green-300), var(--blue-300));
            text-align: center;
            padding: 1rem;
        }
        .menu-title { font-size: 3.75rem; font-weight: 700; color: var(--white); text-shadow: 2px 2px 4px rgba(0,0,0,0.2); margin-bottom: 1rem; }
        .menu-subtitle { font-size: 1.25rem; color: rgba(255,255,255,0.9); margin-bottom: 2rem; }
        .menu-button {
            background-color: var(--yellow-400); color: var(--yellow-900); font-weight: 700; padding: 1rem 2.5rem;
            border-radius: 9999px; font-size: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            transition: all 0.3s ease-in-out;
        }
        .menu-button:hover { background-color: var(--yellow-300); transform: scale(1.05); }

        /* --- Game Screen --- */
        .game-container {
            min-height: 100vh;
            background-image: linear-gradient(to bottom, var(--sky-200), var(--green-300));
            position: relative;
            overflow: hidden;
            padding-bottom: 80px; /* Space for nav */
        }
        #background-animations { position: absolute; inset: 0; overflow: hidden; pointer-events: none; }
        #background-animations div { position: absolute; opacity: 0.2; animation: float 6s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        .header {
            position: sticky; top: 0; z-index: 20;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            padding: 0.5rem;
        }
        .header-content { max-width: 1280px; margin: auto; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 0.5rem; }
        .header-stats { display: flex; align-items: center; gap: 0.5rem; }
        .stat-bubble { display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; }
        .stat-bubble .icon { font-size: 1.125rem; }
        .stat-bubble span { font-weight: 700; }
        .stat-bubble i { width: 14px; height: 14px; }
        #coins-display-container { background-color: var(--yellow-100); color: var(--yellow-800); }
        #gems-display-container { background-color: var(--cyan-100); color: var(--cyan-800); }
        #prestige-display-container { background-color: var(--purple-100); color: var(--purple-600); }
        .season-tracker { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 9999px; }
        .season-tracker i { width: 20px; height: 20px; }
        .level-tracker { margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
        .level-tracker span { font-weight: 700; color: #1d4ed8; }
        .progress-bar-container { width: 100%; background-color: var(--gray-300); border-radius: 9999px; height: 0.625rem; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 9999px; transition: width 0.3s; }
        .xp-text { font-size: 0.75rem; text-align: center; color: var(--gray-600); margin-top: 0.25rem; }

        .combo-bubble {
            position: fixed; top: 6rem; left: 50%; transform: translateX(-50%); z-index: 30;
            background-color: var(--purple-500); color: var(--white); font-weight: 700;
            padding: 0.5rem 1rem; border-radius: 9999px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-size: 1.125rem;
        }

        /* --- Plants Area --- */
        .plants-area {
            position: relative; z-index: 10; padding: 1rem; max-width: 1280px; margin: auto;
            display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1rem;
        }
        @media (min-width: 768px) { .plants-area { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (min-width: 1024px) { .plants-area { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        .plant-card {
            padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-width: 2px;
        }
        .plant-card header { display: flex; justify-content: space-between; align-items: flex-start; }
        .plant-card .info { display: flex; align-items: center; gap: 0.75rem; }
        .plant-card .info i { width: 40px; height: 40px; }
        .plant-card h3 { font-weight: 700; font-size: 1.125rem; color: var(--gray-800); margin: 0; }
        .plant-card p { font-size: 0.875rem; color: var(--gray-600); margin: 0; }
        .plant-card .upgrade-btn {
            background-color: var(--green-500); color: var(--white); padding: 0.25rem 0.5rem;
            border-radius: 0.375rem; font-size: 0.75rem;
        }
        .plant-card .upgrade-btn:hover { background-color: var(--green-600); }
        .plant-card .upgrade-btn:disabled { background-color: var(--gray-400); }
        .plant-card .grow-area { margin-top: 0.75rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .plant-card .growth-row { display: flex; align-items: center; gap: 0.5rem; }
        .plant-card .growth-row .progress-bar-container { height: 1rem; }
        .plant-card .harvest-btn {
            background-color: var(--yellow-400); color: var(--yellow-900); padding: 0.25rem 0.75rem;
            font-size: 0.875rem; border-radius: 0.375rem; font-weight: 600;
        }
        .plant-card .harvest-btn:hover { background-color: var(--yellow-300); }
        .plant-card .status-text { width: 5rem; text-align: center; font-size: 0.875rem; }
        .plant-card .plant-new-btn {
            width: 100%; background-color: var(--blue-500); color: var(--white); padding: 0.25rem;
            border-radius: 0.375rem; margin-top: 0.5rem;
        }
        .plant-card .plant-new-btn:hover { background-color: var(--blue-600); }


        /* --- Bottom Navigation --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px);
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 30;
        }
        .bottom-nav div { max-width: 1280px; margin: auto; display: flex; justify-content: space-around; padding: 0.5rem; }
        .bottom-nav button { display: flex; flex-direction: column; align-items: center; color: var(--gray-600); }
        .bottom-nav button:hover { color: var(--green-600); }
        .bottom-nav button:disabled { color: #d1d5db; }
        .bottom-nav i { width: 24px; height: 24px; }


        /* --- Modal Screens --- */
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 40;
            display: flex; justify-content: center; align-items: center; padding: 1rem;
        }
        .modal-content {
            background-color: var(--white); border-radius: 0.5rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            width: 100%; max-width: 672px; max-height: 90vh;
            display: flex; flex-direction: column;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #e5e7eb; }
        .modal-header h2 { font-size: 1.5rem; font-weight: 700; margin: 0; }
        .modal-header button { color: var(--gray-500); }
        .modal-header button:hover { color: var(--gray-800); }
        .modal-body { padding: 1rem; overflow-y: auto; }
        .shop-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 768px) { .shop-grid { grid-template-columns: 1fr 1fr; } }
        .shop-item { padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; }
        .shop-item.locked { background-color: var(--gray-200); }
        .shop-item.unlocked { background-color: var(--green-50); }
        .shop-item .info { display: flex; align-items: center; gap: 0.75rem; }
        .shop-item .info i { width: 32px; height: 32px; }
        .shop-item h4 { font-weight: 700; margin: 0; }
        .shop-item p { font-size: 0.75rem; color: var(--gray-600); margin: 0; }
        .shop-item .buy-container { margin-top: 0.5rem; display: flex; justify-content: flex-end; }
        .shop-item .buy-btn {
            background-color: var(--yellow-400); color: var(--yellow-900); font-weight: 600;
            padding: 0.25rem 1rem; border-radius: 0.375rem; font-size: 0.875rem;
        }
        .shop-item .buy-btn:hover { background-color: var(--yellow-300); }
        .shop-item .buy-btn:disabled { background-color: var(--gray-400); color: var(--gray-600); }
        .upgrade-list, .achievement-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .upgrade-item { padding: 0.75rem; border-radius: 0.5rem; background-color: #eff6ff; display: flex; align-items: center; justify-content: space-between; }
        .upgrade-item i { color: var(--blue-500); width: 32px; height: 32px; }
        .upgrade-item button { background-color: var(--blue-500); color: var(--white); font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.375rem; }
        .upgrade-item button:hover { background-color: var(--blue-600); }
        .upgrade-item button:disabled { background-color: var(--gray-400); }
        .achievement-item { padding: 0.75rem; border-radius: 0.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .achievement-item.locked { background-color: var(--gray-100); }
        .achievement-item.unlocked { background-color: var(--yellow-100); }
        .achievement-item .icon-container { padding: 0.5rem; border-radius: 9999px; }
        .achievement-item.locked .icon-container { background-color: var(--gray-300); }
        .achievement-item.unlocked .icon-container { background-color: var(--yellow-400); }
        .achievement-item i { width: 24px; height: 24px; }
        .achievement-item.locked i { color: var(--gray-500); }
        .achievement-item.unlocked i { color: var(--white); }
        .achievement-item.unlocked h4 { color: var(--yellow-900); }
        .prestige-content { text-align: center; }
        .prestige-content p { margin-bottom: 1rem; }
        .prestige-info { margin: 1.5rem 0; padding: 1rem; background-color: var(--purple-100); border-radius: 0.5rem; }
        .prestige-info p { font-size: 1.125rem; margin: 0; }
        .prestige-info .gain-text { font-size: 1.25rem; font-weight: 700; color: var(--purple-700); margin-top: 0.5rem; }
        .prestige-btn {
            width: 100%; background-color: var(--purple-600); color: var(--white); font-weight: 700;
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-size: 1.125rem;
        }
        .prestige-btn:hover { background-color: var(--purple-700); }
        .prestige-btn:disabled { background-color: var(--gray-400); }


        /* --- Particles & Notifications --- */
        .particle-container { position: fixed; inset: 0; pointer-events: none; z-index: 50; }
        .particle-item { position: absolute; animation: particle-fade 2s ease-out forwards; font-weight: 700; font-size: 1.125rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        @keyframes particle-fade { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-80px); opacity: 0; } }

        .notification-container { position: fixed; top: 5rem; right: 1rem; z-index: 50; display: flex; flex-direction: column; gap: 0.5rem; }
        .notification-item { animation: notification-fade 4s ease-in-out forwards; background-color: var(--gray-800); color: var(--white); padding: 0.5rem 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-size: 0.875rem; }
        @keyframes notification-fade { 0% { opacity: 0; transform: translateX(100%); } 10% { opacity: 1; transform: translateX(0); } 90% { opacity: 1; transform: translateX(0); } 100% { opacity: 0; transform: translateX(100%); } }

        /* --- Loading Screen --- */
        #loading-screen {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background-color: var(--loading-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity var(--transition-speed);
        }
        
        .loading-container {
            text-align: center;
            color: var(--loading-text);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--green-300);
            border-top-color: var(--green-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- Accessibility Improvements --- */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles */
        button:focus-visible,
        a:focus-visible {
            outline: 2px solid var(--blue-500);
            outline-offset: 2px;
        }

        /* High contrast mode improvements */
        @media (forced-colors: active) {
            .button {
                border: 2px solid currentColor;
            }
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="screen" aria-live="polite">
        <div class="loading-container">
            <h2>Loading...</h2>
            <div class="loading-spinner"></div>
        </div>
    </div>

    <div id="app" aria-hidden="true">
        <div id="screen-menu" class="screen">
            <div class="menu-container">
                <h1 class="menu-title">Garden Idle</h1>
                <p class="menu-subtitle">Grow your garden, earn coins, and become a master gardener!</p>
                <button id="play-button" class="menu-button" aria-label="Start playing Garden Idle">Play Game</button>
            </div>
        </div>

        <div id="screen-game" class="screen hidden">
            <div class="game-container">
                <div id="background-animations"></div>
                
                <header class="header">
                    <div class="header-content">
                        <div class="header-stats">
                            <div class="stat-bubble" id="coins-display-container">
                                <span class="icon">ðŸ’°</span><span id="coins-display">25</span>
                            </div>
                            <div class="stat-bubble hidden" id="gems-display-container">
                                <span class="icon">ðŸ’Ž</span><span id="gems-display">0</span>
                            </div>
                            <div class="stat-bubble hidden" id="prestige-display-container">
                                <i data-lucide="crown"></i><span id="prestige-display">0</span>
                            </div>
                        </div>
                        <div class="season-tracker" id="season-display-container">
                            <i data-lucide="leaf"></i>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="season-progress"></div>
                            </div>
                        </div>
                    </div>
                    <div class="level-tracker">
                        <span id="level-display">Lvl 1</span>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="xp-progress" style="background-color: var(--blue-500);"></div>
                        </div>
                    </div>
                    <p class="xp-text" id="xp-display">0 / 100 EXP</p>
                </header>
                
                <div id="combo-display" class="combo-bubble hidden"></div>
                
                <main id="plants-container" class="plants-area"></main>
                
                <nav class="bottom-nav">
                    <div>
                        <button data-screen="shop"><i data-lucide="shopping-cart"></i> Shop</button>
                        <button data-screen="upgrades"><i data-lucide="trending-up"></i> Upgrades</button>
                        <button data-screen="achievements"><i data-lucide="trophy"></i> Achievements</button>
                        <button data-screen="prestige" id="prestige-nav-button" disabled><i data-lucide="star"></i> Prestige</button>
                    </div>
                </nav>
            </div>
        </div>

        <div id="modal-container" class="modal-overlay hidden">
            <div class="modal-content">
                <header class="modal-header">
                    <h2 id="modal-title"></h2>
                    <button id="modal-close-button"><i data-lucide="x"></i></button>
                </header>
                <main id="modal-body" class="modal-body"></main>
            </div>
        </div>
    </div>
    
    <div id="particle-container" class="particle-container"></div>
    <div id="notification-container" class="notification-container"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- STATE MANAGEMENT ---
        let state = {};
        const SAVE_KEY = 'garden_idle_save';

        function saveGame() {
            try {
                localStorage.setItem(SAVE_KEY, JSON.stringify(state));
            } catch (error) {
                console.error('Failed to save game:', error);
            }
        }

        function loadGame() {
            try {
                const savedState = localStorage.getItem(SAVE_KEY);
                if (savedState) {
                    return { ...getInitialState(), ...JSON.parse(savedState) };
                }
            } catch (error) {
                console.error('Failed to load game:', error);
            }
            return getInitialState();
        }

        function getInitialState() {
            return {
                gameState: 'menu',
                coins: 25,
                gems: 0,
                totalCoinsEarned: 25,
                level: 1,
                experience: 0,
                experienceToNext: 100,
                prestigePoints: 0,
                currentSeason: 'spring',
                seasonTimer: 0,
                plants: {
                    flower: { count: 2, level: 1, autoHarvesters: 0, growing: [], multiplier: 1 }, herb: { count: 0, level: 1, autoHarvesters: 0, growing: [], multiplier: 1 }, sprout: { count: 0, level: 1, autoHarvesters: 0, growing: [], multiplier: 1 }, berry: { count: 0, level: 1, autoHarvesters: 0, growing: [], multiplier: 1 }, tree: { count: 0, level: 1, autoHarvesters: 0, growing: [], multiplier: 1 }, fruit: { count: 0, level: 1, autoHarvesters: 0, growing: [], multiplier: 1 }, exotic: { count: 0, level: 1, autoHarvesters: 0, growing: [], multiplier: 1 }, crystal: { count: 0, level: 1, autoHarvesters: 0, growing: [], multiplier: 1 }, magical: { count: 0, level: 1, autoHarvesters: 0, growing: [], multiplier: 1 }, celestial: { count: 0, level: 1, autoHarvesters: 0, growing: [], multiplier: 1 }
                },
                globalUpgrades: {
                    coinMultiplier: { level: 0, cost: 100, multiplier: 1.5, maxLevel: 20, name: 'Coin Multiplier', icon: 'sparkles' }, speedBoost: { level: 0, cost: 200, multiplier: 1.3, maxLevel: 15, name: 'Speed Boost', icon: 'zap' }, autoPlanter: { level: 0, cost: 500, multiplier: 1, maxLevel: 10, name: 'Auto Planter', icon: 'rocket' }, luckyHarvest: { level: 0, cost: 1000, multiplier: 1.1, maxLevel: 25, name: 'Lucky Harvest', icon: 'star' }, gemFinder: { level: 0, cost: 2000, multiplier: 1, maxLevel: 10, name: 'Gem Finder', icon: 'gem' }, seasonMaster: { level: 0, cost: 5000, multiplier: 1, maxLevel: 5, name: 'Season Master', icon: 'cloud' }, prestigeBonus: { level: 0, cost: 10000, multiplier: 1.2, maxLevel: 50, name: 'Prestige Bonus', icon: 'crown' }
                },
                achievements: new Set(),
                comboMultiplier: 1,
                comboTimer: 0,
            };
        }
        
        // --- CONSTANTS & GAME DATA ---
        const plantTypes = [
            { id: 'flower', name: 'Flowers', icon: 'flower-2', color: '#ec4899', bgColor: '#fff1f2', baseValue: 1, baseTime: 2000 },
            { id: 'herb', name: 'Herbs', icon: 'leaf', color: '#4ade80', bgColor: '#dcfce7', baseValue: 3, baseTime: 3000 },
            { id: 'sprout', name: 'Sprouts', icon: 'sprout', color: '#22c55e', bgColor: '#dcfce7', baseValue: 8, baseTime: 4500 },
            { id: 'berry', name: 'Berries', icon: 'droplets', color: '#ef4444', bgColor: '#fee2e2', baseValue: 15, baseTime: 6000 },
            { id: 'tree', name: 'Trees', icon: 'tree-pine', color: '#047857', bgColor: '#d1fae5', baseValue: 35, baseTime: 9000 },
            { id: 'fruit', name: 'Fruit Trees', icon: 'sun', color: '#f97316', bgColor: '#fff7ed', baseValue: 75, baseTime: 12000 },
            { id: 'exotic', name: 'Exotic Plants', icon: 'star', color: '#a855f7', bgColor: '#f5f3ff', baseValue: 150, baseTime: 18000 },
            { id: 'crystal', name: 'Crystal Flowers', icon: 'gem', color: '#06b6d4', bgColor: '#cffafe', baseValue: 300, baseTime: 25000 },
            { id: 'magical', name: 'Magical Trees', icon: 'crown', color: '#4f46e5', bgColor: '#e0e7ff', baseValue: 600, baseTime: 35000 },
            { id: 'celestial', name: 'Celestial Gardens', icon: 'rocket', color: '#eab308', bgColor: '#fef9c3', baseValue: 1200, baseTime: 50000 }
        ];

        const shopItems = [
            { id: 'flower_plant', type: 'plant', plant: 'flower', name: 'Flower Bed', cost: 20, description: 'Beautiful flowers that bloom quickly' }, { id: 'herb_plant', type: 'plant', plant: 'herb', name: 'Herb Garden', cost: 50, description: 'Aromatic herbs', unlockReq: 30 }, { id: 'sprout_plant', type: 'plant', plant: 'sprout', name: 'Sprout Garden', cost: 150, description: 'Fresh green sprouts', unlockReq: 100 }, { id: 'berry_plant', type: 'plant', plant: 'berry', name: 'Berry Bush', cost: 400, description: 'Sweet berries', unlockReq: 300 }, { id: 'tree_plant', type: 'plant', plant: 'tree', name: 'Tree Grove', cost: 1200, description: 'Mighty trees', unlockReq: 800 }, { id: 'fruit_plant', type: 'plant', plant: 'fruit', name: 'Fruit Orchard', cost: 3000, description: 'Delicious fruit trees', unlockReq: 2000 }, { id: 'exotic_plant', type: 'plant', plant: 'exotic', name: 'Exotic Garden', cost: 8000, description: 'Rare exotic plants', unlockReq: 5000 }, { id: 'crystal_plant', type: 'plant', plant: 'crystal', name: 'Crystal Garden', cost: 20000, description: 'Mystical crystal flowers', unlockReq: 15000 }, { id: 'magical_plant', type: 'plant', plant: 'magical', name: 'Magical Forest', cost: 50000, description: 'Enchanted magical trees', unlockReq: 35000 }, { id: 'celestial_plant', type: 'plant', plant: 'celestial', name: 'Celestial Garden', cost: 150000, description: 'Gardens blessed by stars', unlockReq: 100000 },
            { id: 'flower_auto', type: 'auto', plant: 'flower', name: 'Flower Bot', cost: 100, description: 'Auto-harvest flowers' }, { id: 'herb_auto', type: 'auto', plant: 'herb', name: 'Herb Bot', cost: 300, description: 'Auto-harvest herbs' }, { id: 'sprout_auto', type: 'auto', plant: 'sprout', name: 'Sprout Bot', cost: 800, description: 'Auto-harvest sprouts' }, { id: 'berry_auto', type: 'auto', plant: 'berry', name: 'Berry Bot', cost: 2000, description: 'Auto-harvest berries' }, { id: 'tree_auto', type: 'auto', plant: 'tree', name: 'Tree Bot', cost: 6000, description: 'Auto-harvest trees' }
        ];

        const achievementList = [
            { id: 'first_coin', name: 'First Harvest', description: 'Earn your first coin', requirement: 1, type: 'coins', reward: 25 }, { id: 'hundred_coins', name: 'Wealthy Gardener', description: 'Earn 100 coins total', requirement: 100, type: 'coins', reward: 100 }, { id: 'thousand_coins', name: 'Garden Tycoon', description: 'Earn 1,000 coins total', requirement: 1000, type: 'coins', reward: 500 }, { id: 'million_coins', name: 'Coin Master', description: 'Earn 1,000,000 coins total', requirement: 1000000, type: 'coins', reward: 10000 }, { id: 'ten_flowers', name: 'Flower Power', description: 'Own 10 flower beds', requirement: 10, type: 'plants', plant: 'flower', reward: 200 }, { id: 'first_herb', name: 'Herbalist', description: 'Grow your first herb', requirement: 1, type: 'plants', plant: 'herb', reward: 100 }, { id: 'first_sprout', name: 'Growing Up', description: 'Grow your first sprout', requirement: 1, type: 'plants', plant: 'sprout', reward: 200 }, { id: 'first_tree', name: 'Tree Hugger', description: 'Grow your first tree', requirement: 1, type: 'plants', plant: 'tree', reward: 500 }, { id: 'level_5', name: 'Expert Gardener', description: 'Reach level 5', requirement: 5, type: 'level', reward: 300 }, { id: 'level_10', name: 'Master Gardener', description: 'Reach level 10', requirement: 10, type: 'level', reward: 1000 }, { id: 'first_gem', name: 'Gem Hunter', description: 'Find your first gem', requirement: 1, type: 'gems', reward: 500 }, { id: 'combo_master', name: 'Combo Master', description: 'Reach a 3x combo multiplier', requirement: 3, type: 'combo', reward: 1000 }
        ];

        const seasons = {
            spring: { name: 'Spring', icon: 'leaf', color: '#22c55e', description: '+20% growth speed' },
            summer: { name: 'Summer', icon: 'sun', color: '#eab308', description: '+30% coin value' },
            autumn: { name: 'Autumn', icon: 'tree-pine', color: '#f97316', description: '+15% experience' },
            winter: { name: 'Winter', icon: 'snowflake', color: '#3b82f6', description: '+50% gem chance' }
        };
        
        // --- DOM ELEMENTS CACHE ---
        const screens = {
            menu: document.getElementById('screen-menu'),
            game: document.getElementById('screen-game'),
        };
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');

        // --- GAME LOGIC FUNCTIONS ---
        function addNotification(message) {
            const container = document.getElementById('notification-container');
            const notif = document.createElement('div');
            notif.className = 'notification-item';
            notif.textContent = message;
            container.appendChild(notif);
            setTimeout(() => notif.remove(), 4000);
        }

        function addParticle(x, y, text, color) {
            const container = document.getElementById('particle-container');
            const particle = document.createElement('div');
            particle.className = 'particle-item';
            particle.textContent = text;
            particle.style.left = `${x}px`;
            particle.style.top = `${y}px`;
            particle.style.color = color;
            container.appendChild(particle);
            setTimeout(() => particle.remove(), 2000);
        }
        
        function getGlobalMultiplier() {
            let multiplier = 1;
            multiplier *= Math.pow(state.globalUpgrades.coinMultiplier.multiplier, state.globalUpgrades.coinMultiplier.level);
            multiplier *= Math.pow(state.globalUpgrades.luckyHarvest.multiplier, state.globalUpgrades.luckyHarvest.level);
            if (state.currentSeason === 'summer') multiplier *= 1.3;
            multiplier *= state.comboMultiplier;
            multiplier *= (1 + state.prestigePoints * 0.1);
            return multiplier;
        }

        function getSpeedMultiplier() {
            let multiplier = 1;
            multiplier *= Math.pow(state.globalUpgrades.speedBoost.multiplier, state.globalUpgrades.speedBoost.level);
            if (state.currentSeason === 'spring') multiplier *= 1.2;
            return multiplier;
        }

        function getPlantValue(plantType, plantLevel) {
            const baseValue = plantTypes.find(p => p.id === plantType)?.baseValue || 1;
            const plantMultiplier = state.plants[plantType]?.multiplier || 1;
            let value = Math.floor(baseValue * Math.pow(1.8, plantLevel - 1) * plantMultiplier);
            value *= getGlobalMultiplier();

            const gemChance = state.currentSeason === 'winter' ? 0.015 : 0.01;
            if (Math.random() < gemChance + (state.globalUpgrades.gemFinder.level * 0.005)) {
                setTimeout(() => {
                    state.gems += 1;
                    addNotification('ðŸ’Ž Found a gem!');
                    renderHeader();
                }, 100);
            }
            return Math.floor(value);
        }

        function getGrowthTime(plantType, plantLevel) {
            const baseTime = plantTypes.find(p => p.id === plantType)?.baseTime || 2000;
            let time = Math.max(300, Math.floor(baseTime / Math.pow(1.15, plantLevel - 1)));
            time /= getSpeedMultiplier();
            return Math.floor(time);
        }

        function startGrowing(plantType) {
            const plantData = state.plants[plantType];
            if (plantData.count === 0) return;
            const availableSlots = plantData.count - plantData.growing.length;
            if (availableSlots <= 0) return;

            const growthTime = getGrowthTime(plantType, plantData.level);
            const newGrowth = { id: Date.now() + Math.random(), startTime: Date.now(), growthTime, progress: 0 };
            plantData.growing.push(newGrowth);
            renderPlants();
        }

        function harvestPlant(plantType, growthId, auto = false) {
            const value = getPlantValue(plantType, state.plants[plantType].level);
            let expGain = Math.ceil(value / 10);
            if (state.currentSeason === 'autumn') expGain = Math.floor(expGain * 1.15);

            state.coins += value;
            state.totalCoinsEarned += value;
            state.experience += expGain;

            if (!auto) {
                state.comboTimer = 5000;
                state.comboMultiplier = Math.min(state.comboMultiplier + 0.1, 5);
                addParticle(Math.random() * (window.innerWidth - 100), Math.random() * (window.innerHeight/2), `+${Math.floor(value)}ðŸ’°`, '#22c55e');
                if (state.comboMultiplier > 1.1) {
                    addParticle(Math.random() * (window.innerWidth - 150), Math.random() * (window.innerHeight/2), `${state.comboMultiplier.toFixed(1)}x COMBO!`, '#a855f7');
                }
            }

            state.plants[plantType].growing = state.plants[plantType].growing.filter(g => g.id !== growthId);

            if (state.plants[plantType].autoHarvesters > 0) {
                setTimeout(() => startGrowing(plantType), 100);
            }
        }

        function manualHarvest(plantType, growthId) {
            harvestPlant(plantType, growthId, false);
            startGrowing(plantType);
        }

        function buyItem(item) {
            if (state.coins < item.cost) return;
            if (item.unlockReq && state.totalCoinsEarned < item.unlockReq) return;

            state.coins -= item.cost;

            if (item.type === 'plant') {
                state.plants[item.plant].count += 1;
                addNotification(`ðŸŒ± Bought ${item.name}!`);
            } else if (item.type === 'auto') {
                state.plants[item.plant].autoHarvesters += 1;
                addNotification(`ðŸ¤– Bought ${item.name}!`);
            }
            renderShop();
            renderHeader();
        }

        function buyGlobalUpgrade(upgradeId) {
            const upgrade = state.globalUpgrades[upgradeId];
            if (!upgrade || state.coins < upgrade.cost || upgrade.level >= upgrade.maxLevel) return;

            state.coins -= upgrade.cost;
            upgrade.level += 1;
            upgrade.cost = Math.floor(upgrade.cost * 1.5);
            addNotification(`âš¡ Bought ${upgrade.name} upgrade!`);
            renderUpgrades();
            renderHeader();
        }

        function upgradePlant(plantType) {
            const cost = Math.floor(100 * Math.pow(2, state.plants[plantType].level - 1));
            if (state.coins < cost) return;

            state.coins -= cost;
            state.plants[plantType].level += 1;
            addNotification(`â¬†ï¸ Upgraded ${plantType} to level ${state.plants[plantType].level}!`);
            renderPlants();
            renderHeader();
        }

        function canPrestige() {
            return state.totalCoinsEarned >= 1000000;
        }

        function doPrestige() {
            if (!canPrestige()) return;
            
            const newPrestigePoints = Math.floor(Math.log10(state.totalCoinsEarned) - 5);
            const oldState = state;
            
            state = getInitialState(); // Reset state
            state.gameState = 'game';
            state.prestigePoints = oldState.prestigePoints + newPrestigePoints;
            state.coins = 50;
            state.totalCoinsEarned = 50;

            // Reset plants but keep some and add prestige multiplier
            const prestigeMultiplier = 1 + (state.prestigePoints * 0.1);
            state.plants.flower = { count: 3, level: 1, autoHarvesters: 0, growing: [], multiplier: prestigeMultiplier };
            state.plants.herb = { count: 1, level: 1, autoHarvesters: 0, growing: [], multiplier: prestigeMultiplier };
            
            Object.keys(state.plants).forEach(p => {
                state.plants[p].multiplier = prestigeMultiplier;
            });

            addNotification(`ðŸŒŸ Prestiged! +${newPrestigePoints} Prestige Points!`);
            showScreen('game');
        }

        function checkAchievements() {
            achievementList.forEach(ach => {
                if (state.achievements.has(ach.id)) return;
                
                let completed = false;
                switch (ach.type) {
                    case 'coins': completed = state.totalCoinsEarned >= ach.requirement; break;
                    case 'plants': completed = state.plants[ach.plant]?.count >= ach.requirement; break;
                    case 'level': completed = state.level >= ach.requirement; break;
                    case 'gems': completed = state.gems >= ach.requirement; break;
                    case 'combo': completed = state.comboMultiplier >= ach.requirement; break;
                }
                
                if (completed) {
                    state.achievements.add(ach.id);
                    addNotification(`ðŸ† Achievement: ${ach.name}! +${ach.reward} coins`);
                    state.coins += ach.reward;
                    renderHeader();
                }
            });
        }

        function levelUpCheck() {
            if (state.experience >= state.experienceToNext) {
                state.level += 1;
                state.experience -= state.experienceToNext;
                state.experienceToNext = Math.floor(state.experienceToNext * 1.4);
                addNotification(`ðŸŒŸ Level ${state.level}! Bonus: +${(state.level-1) * 20} coins`);
                state.coins += (state.level-1) * 20;
                renderHeader();
            }
        }
        
        // --- SCREEN & MODAL MANAGEMENT ---
        function showScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
                state.gameState = screenName;
            }
            modalContainer.classList.add('hidden');

            if (screenName === 'game') {
                render(); // Full re-render when returning to game
            }
        }

        function showModal(screenName) {
            modalContainer.classList.remove('hidden');
            state.gameState = screenName;
            switch(screenName) {
                case 'shop': renderShop(); break;
                case 'upgrades': renderUpgrades(); break;
                case 'achievements': renderAchievements(); break;
                case 'prestige': renderPrestige(); break;
            }
        }

        // --- DYNAMIC CONTENT RENDERING ---
        function renderHeader() {
            document.getElementById('coins-display').textContent = state.coins.toLocaleString();
            const gemsContainer = document.getElementById('gems-display-container');
            if (state.gems > 0) {
                gemsContainer.classList.remove('hidden');
                document.getElementById('gems-display').textContent = state.gems;
            } else {
                gemsContainer.classList.add('hidden');
            }
            const prestigeContainer = document.getElementById('prestige-display-container');
            if (state.prestigePoints > 0) {
                prestigeContainer.classList.remove('hidden');
                document.getElementById('prestige-display').textContent = state.prestigePoints;
            } else {
                prestigeContainer.classList.add('hidden');
            }

            document.getElementById('level-display').textContent = `Lvl ${state.level}`;
            document.getElementById('xp-display').textContent = `${state.experience.toFixed(0)} / ${state.experienceToNext.toFixed(0)} EXP`;
            document.getElementById('xp-progress').style.width = `${(state.experience / state.experienceToNext) * 100}%`;

            const season = seasons[state.currentSeason];
            const seasonContainer = document.getElementById('season-display-container');
            seasonContainer.querySelector('i').setAttribute('data-lucide', season.icon);
            seasonContainer.style.color = season.color;
            seasonContainer.style.backgroundColor = season.color + '20';
            document.getElementById('season-progress').style.width = `${(state.seasonTimer / 60000) * 100}%`;
            document.getElementById('season-progress').style.backgroundColor = season.color;

            const comboDisplay = document.getElementById('combo-display');
            if (state.comboMultiplier > 1) {
                comboDisplay.classList.remove('hidden');
                comboDisplay.textContent = `${state.comboMultiplier.toFixed(1)}x COMBO!`;
            } else {
                comboDisplay.classList.add('hidden');
            }
            
            lucide.createIcons();
        }
        
        function renderPlants() {
           const container = document.getElementById('plants-container');
           container.innerHTML = '';
           
           plantTypes.filter(pt => state.plants[pt.id].count > 0).forEach(plantType => {
                const plantData = state.plants[plantType.id];
                const card = document.createElement('div');
                card.className = 'plant-card';
                card.style.backgroundColor = plantType.bgColor;
                card.style.borderColor = plantType.color + '80';

                const upgradeCost = Math.floor(100 * Math.pow(2, plantData.level - 1));

                let growingHTML = plantData.growing.map(growth => {
                    const harvestButton = growth.progress >= 100 && plantData.autoHarvesters === 0
                        ? `<button class="harvest-btn" data-plant-type="${plantType.id}" data-growth-id="${growth.id}">Harvest</button>`
                        : `<div class="status-text">${plantData.autoHarvesters > 0 ? "Auto" : "..."}</div>`;

                    return `
                        <div class="growth-row">
                            <div class="progress-bar-container"><div class="progress-bar" style="width:${growth.progress}%; background-color:${plantType.color};"></div></div>
                            ${harvestButton}
                        </div>
                    `;
                }).join('');

                const plantNewButton = plantData.count > plantData.growing.length && plantData.autoHarvesters === 0
                    ? `<button class="plant-new-btn" data-plant-type="${plantType.id}">Plant New</button>`
                    : '';
                    
                card.innerHTML = `
                    <header>
                        <div class="info">
                            <i data-lucide="${plantType.icon}" style="color:${plantType.color};" role="img" aria-label="${plantType.name} icon"></i>
                            <div>
                                <h3 id="${plantType.id}-title">${plantType.name}</h3>
                                <p id="${plantType.id}-stats">Owned: ${plantData.count} | Level: ${plantData.level}</p>
                            </div>
                        </div>
                        <button class="upgrade-btn" 
                            data-plant-type="${plantType.id}" 
                            aria-labelledby="${plantType.id}-upgrade-label"
                            ${state.coins < upgradeCost ? 'disabled' : ''}>
                            <span id="${plantType.id}-upgrade-label" class="visually-hidden">Upgrade ${plantType.name} for</span>
                            Up: ${upgradeCost.toLocaleString()}ðŸ’°
                        </button>
                    </header>
                    <div class="grow-area" role="group" aria-labelledby="${plantType.id}-title">
                        ${growingHTML}
                        ${plantNewButton ? `<button class="plant-new-btn" 
                            data-plant-type="${plantType.id}"
                            aria-label="Plant new ${plantType.name}">Plant New</button>` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }
        
        function renderNav() {
            document.getElementById('prestige-nav-button').disabled = !canPrestige();
        }
        
        function renderShop() {
            modalTitle.textContent = 'Shop';
            const content = shopItems.map(item => {
                const isLocked = item.unlockReq && state.totalCoinsEarned < item.unlockReq;
                const canAfford = state.coins >= item.cost;
                const plant = plantTypes.find(p => p.id === item.plant);
                const disabled = isLocked || !canAfford;
                return `
                    <div class="shop-item ${isLocked ? 'locked' : 'unlocked'}">
                        <div class="info">
                           ${plant ? `<i data-lucide="${plant.icon}" style="color:${plant.color}"></i>` : ''}
                            <div>
                                <h4>${item.name}</h4>
                                <p>${item.description}</p>
                            </div>
                        </div>
                        <div class="buy-container">
                            <button class="buy-btn" data-item-id="${item.id}" ${disabled ? 'disabled' : ''}>
                                ${isLocked ? `Unlock at ${item.unlockReq.toLocaleString()} total ðŸ’°` : `${item.cost.toLocaleString()} ðŸ’°`}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            modalBody.innerHTML = `<div class="shop-grid">${content}</div>`;
            lucide.createIcons();
        }

        function renderUpgrades() {
            modalTitle.textContent = 'Global Upgrades';
            const content = Object.entries(state.globalUpgrades).map(([id, up]) => {
                const isMaxed = up.level >= up.maxLevel;
                const canAfford = state.coins >= up.cost;
                const disabled = isMaxed || !canAfford;
                return `
                    <div class="upgrade-item">
                        <div class="info">
                            <i data-lucide="${up.icon}"></i>
                            <div>
                                <h4>${up.name}</h4>
                                <p>Level ${up.level} / ${up.maxLevel}</p>
                            </div>
                        </div>
                        <button data-upgrade-id="${id}" ${disabled ? 'disabled' : ''}>
                             ${isMaxed ? 'Maxed Out' : `${up.cost.toLocaleString()} ðŸ’°`}
                        </button>
                    </div>
                `;
            }).join('');
            modalBody.innerHTML = `<div class="upgrade-list">${content}</div>`;
            lucide.createIcons();
        }
        
        function renderAchievements() {
            modalTitle.textContent = 'Achievements';
            const content = achievementList.map(ach => {
                const isUnlocked = state.achievements.has(ach.id);
                return `
                    <div class="achievement-item ${isUnlocked ? 'unlocked' : 'locked'}">
                        <div class="icon-container"><i data-lucide="trophy"></i></div>
                        <div>
                            <h4>${ach.name}</h4>
                            <p>${ach.description}</p>
                        </div>
                    </div>
                `;
            }).join('');
            modalBody.innerHTML = `<div class="achievement-list">${content}</div>`;
            lucide.createIcons();
        }

        function renderPrestige() {
            modalTitle.textContent = 'Prestige';
            const willGain = canPrestige() ? Math.floor(Math.log10(state.totalCoinsEarned) - 5) : 0;
            modalBody.innerHTML = `
                <div class="prestige-content">
                    <p>Prestiging will reset your coins, plants, and levels, but you will gain Prestige Points.</p>
                    <p>Each Prestige Point grants a permanent <strong>10%</strong> boost to all coin earnings!</p>
                    <div class="prestige-info">
                        <p>Current Total Coins Earned: <strong>${state.totalCoinsEarned.toLocaleString()}</strong></p>
                        <p>Prestige Requirement: <strong>1,000,000</strong></p>
                        ${canPrestige() ? `<p class="gain-text">You will gain ${willGain} Prestige Points!</p>` : ''}
                    </div>
                    <button id="prestige-confirm-btn" class="prestige-btn" ${!canPrestige() ? 'disabled' : ''}>
                        ${canPrestige() ? 'Prestige Now' : 'Not enough coins'}
                    </button>
                </div>
            `;
        }

        function render() {
            renderHeader();
            renderPlants();
            renderNav();
        }
        
        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('play-button').addEventListener('click', () => showScreen('game'));
            
            document.querySelector('.bottom-nav').addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button && button.dataset.screen) {
                    showModal(button.dataset.screen);
                }
            });

            document.getElementById('modal-close-button').addEventListener('click', () => showScreen('game'));

            modalBody.addEventListener('click', e => {
                const buyBtn = e.target.closest('.buy-btn');
                const upgradeBtn = e.target.closest('[data-upgrade-id]');
                const prestigeBtn = e.target.closest('#prestige-confirm-btn');
                if (buyBtn) {
                    const item = shopItems.find(i => i.id === buyBtn.dataset.itemId);
                    if (item) buyItem(item);
                }
                if (upgradeBtn) {
                    buyGlobalUpgrade(upgradeBtn.dataset.upgradeId);
                }
                if(prestigeBtn) {
                    doPrestige();
                }
            });

            document.getElementById('plants-container').addEventListener('click', e => {
                const target = e.target;
                if (target.matches('.harvest-btn')) {
                    manualHarvest(target.dataset.plantType, parseFloat(target.dataset.growthId));
                    render();
                } else if (target.matches('.plant-new-btn')) {
                    startGrowing(target.dataset.plantType);
                } else if (target.matches('.upgrade-btn')) {
                    upgradePlant(target.dataset.plantType);
                }
            });
        }
        
        // --- GAME LOOP ---
        function gameLoop() {
            // Update growing progress
            Object.values(state.plants).forEach(plantData => {
                plantData.growing.forEach(growth => {
                    const elapsed = Date.now() - growth.startTime;
                    growth.progress = Math.min(100, (elapsed / growth.growthTime) * 100);

                    if (growth.progress >= 100 && plantData.autoHarvesters > 0) {
                        harvestPlant(plantTypes.find(pt => state.plants[pt.id] === plantData).id, growth.id, true);
                    }
                });
            });

            // Auto-start new growth with auto-harvesters
            Object.keys(state.plants).forEach(plantType => {
                const plantData = state.plants[plantType];
                if (plantData.autoHarvesters > 0) {
                    const availableSlots = plantData.count - plantData.growing.length;
                    if(availableSlots > 0) {
                        startGrowing(plantType);
                    }
                }
            });

            // Check for level ups and achievements
            levelUpCheck();
            checkAchievements();
            
            // Only re-render if in the game screen to save performance
            if (state.gameState === 'game') {
                render();
            }
        }

        function timersLoop() {
             // Combo timer
            if (state.comboTimer > 0) {
                state.comboTimer -= 100;
                if (state.comboTimer <= 0) {
                    state.comboMultiplier = 1;
                    renderHeader();
                }
            }
            // Season timer
            state.seasonTimer += 1000;
            if (state.seasonTimer >= 60000) {
                const order = ['spring', 'summer', 'autumn', 'winter'];
                const nextIndex = (order.indexOf(state.currentSeason) + 1) % order.length;
                state.currentSeason = order[nextIndex];
                state.seasonTimer = 0;
                const newSeason = seasons[state.currentSeason];
                addNotification(`ðŸŒ Season changed to ${newSeason.name}! ${newSeason.description}`);
                renderHeader();
            }
        }
        
        // --- ERROR HANDLING ---
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            addNotification(`âš ï¸ An error occurred. Please try again.`);
        }

        window.addEventListener('error', (event) => {
            handleError(event.error, 'global');
        });

        // --- PERFORMANCE OPTIMIZATIONS ---
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        const debouncedSave = debounce(saveGame, 1000);

        // --- INITIALIZATION ---
        async function init() {
            try {
                const loadingScreen = document.getElementById('loading-screen');
                const app = document.getElementById('app');

                // Load saved state or get initial state
                state = loadGame();
                
                // Setup event listeners
                setupEventListeners();

                // Initialize game loops
                const gameLoopInterval = setInterval(gameLoop, 100);
                const timersLoopInterval = setInterval(timersLoop, 1000);

                // Add auto-save on state changes
                const gameStateProxy = new Proxy(state, {
                    set(target, property, value) {
                        target[property] = value;
                        debouncedSave();
                        return true;
                    }
                });

                // Handle visibility change (tab switching)
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        saveGame();
                    }
                });

                // Handle before unload
                window.addEventListener('beforeunload', () => {
                    saveGame();
                });

                // Show app and hide loading screen
                loadingScreen.style.opacity = '0';
                app.setAttribute('aria-hidden', 'false');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    showScreen('menu');
                }, 300);

            } catch (error) {
                handleError(error, 'initialization');
            }
        }
        
        init();
    });
    </script>
</body>
</html>
